name: 构建并通过SCP部署
on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 拉取代码
        uses: actions/checkout@v4

      - name: 配置Node环境
        uses: actions/setup-node@v4
        with:
          node-version: "22.12"
          cache: "npm"

      - name: 安装依赖
        run: npm ci

      - name: 构建项目
        run: npm run build

      - name: 验证构建产物
        run: |
          echo "构建产物目录内容："
          ls -la ./dist

      - name: 使用SCP传输文件到服务器
        uses: appleboy/scp-action@v1
        with:
          # 服务器连接信息
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASS }}
          port: 22 # 默认为22，非默认端口需修改

          # 传输配置
          source: "./dist/*" # 本地源文件/目录（相对于工作目录）
          target: "/www" # 服务器目标目录
          overwrite: true # 覆盖已有文件
          recursive: true # 递归传输目录（含子目录）

          # 调试与超时设置
          debug: true # 显示详细传输日志
          timeout: 60s # 传输超时时间

      - name: 验证服务器文件
        uses: appleboy/ssh-action@v1.0.2 # 配合使用SSH Action验证结果
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "===== 服务器/www目录内容 ====="
            ls -la /www
            if [ -f "/www/index.html" ]; then
              echo "✅ 传输成功：前端入口文件存在"
            else
              echo "❌ 传输失败：未找到index.html"
              exit 1
            fi
